AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for PII Redaction Lambda function using Bedrock'

Resources:
  PIIRedactionLambdaRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'bedrock:InvokeModel'
                Resource: 
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-haiku-20240307-v1:0'

  PIIRedactionLambda:
    Type: 'AWS::Lambda::Function'
    Properties:
      FunctionName: redactPIIHungarian
      Handler: index.lambda_handler
      Role: !GetAtt PIIRedactionLambdaRole.Arn
      Code:
        ZipFile: |
          import json
          import boto3

          bedrock = boto3.client("bedrock-runtime")

          def lambda_handler(event, context):
              print("Event:", json.dumps(event))
              original = event.get("original")

              prompt = f'Redact words with Personally Identifyable Information including Names, Addresses, Account Numbers, Phone Numbers  from the Hungarian sentence below, by replacing the redacted words with the token, "[PII_Type]", where PII_Type is the type of word that was redacted. Keep all other words unchanged. Output only the redacted sentence with no preamble. <sentence>{original}</sentence>'
          
              request_body = {
                  "anthropic_version": "bedrock-2023-05-31",
                  "max_tokens": 2048,
                  "messages": [
                      {
                          "role": "user",
                          "content": prompt
                      }
                  ],
                  "temperature": 0
              }
              print("Request body", json.dumps(request_body))
              response = bedrock.invoke_model(
                  modelId='anthropic.claude-3-haiku-20240307-v1:0',
                  body=json.dumps(request_body)
              )      
              response_body = json.loads(response['body'].read())
              redacted = response_body['content'][0]['text']
              print(f"Original: {original}, Redacted: {redacted}")
              if (original != redacted):
                  print("PII REDACTED")
              return {
                  'original': original,
                  'redacted': redacted
              }
      Runtime: python3.12
      Timeout: 30
      MemorySize: 128
